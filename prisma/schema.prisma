generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id         Int       @id @default(autoincrement())
  name       String    @unique
  password   String
  created_at DateTime  @default(now()) @db.Timestamp(6)
  reserves   reserve[]
}

model admin {
  adm_id     Int      @id @default(autoincrement())
  adm_name   String   @unique @db.VarChar(30)
  password   String   @db.VarChar(255) // ハッシュ化に対応できるよう長めに
  exp        String
  created_at DateTime @default(now()) @db.Timestamp(6)
}

model menu {
  m_id     Int      @id @default(autoincrement())
  m_name   String   @db.VarChar(100)
  detail   String?
  orderFlg Boolean? @default(true)
  price    Int
  t_id     Int      @db.SmallInt
  menuType menuType @relation(fields: [t_id], references: [t_id])
  courseCtl courseCtl[] 
  reserveDetail reserveDetail[] // リレーションの逆参照用
}

model menuType {
  t_id         Int     @id @default(autoincrement()) @db.SmallInt
  t_name       String? @unique @db.VarChar(30)
  displayOrder Int?    @default(0)
  menu         menu[]
  course    course[] 
}

model table_loc {
  table_id     Int       @id @default(autoincrement())
  table_name   String    @unique @db.VarChar(30)
  max_capacity Int
  reserves     reserve[]
}

model reserve {
  rsv_id    Int       @id @default(autoincrement())
  id        Int
  users     users     @relation(fields: [id], references: [id])
  rsv_date  DateTime  @db.Timestamp(6)
  person    Int
  table_id  Int
  table_loc table_loc @relation(fields: [table_id], references: [table_id])
  app_date  DateTime  @default(now()) @db.Timestamp(6)
  // デフォルトを 'pending' (予約中) にしておくと、新規予約時に自動で設定されます
  status    String   @default("pending")
  details   reserveDetail[]
}

// ★今回の目玉：予約の注文明細
model reserveDetail {
  rd_id    Int     @id @default(autoincrement())
  rsv_id   Int
  m_id     Int?    // 単品メニューID
  c_id     Int?    // コースID
  quantity Int     @default(1)

  reserve  reserve @relation(fields: [rsv_id], references: [rsv_id], onDelete: Cascade)
  menu     menu?   @relation(fields: [m_id], references: [m_id])
  course   course? @relation(fields: [c_id], references: [c_id])
}
model course {
  c_id      Int       @id @default(autoincrement())
  c_name    String    @db.VarChar(30)
  detail    String?
  orderFlg Boolean @default(true)
  price    Int
  t_id     Int
  menuType menuType @relation(fields: [t_id], references: [t_id]) 
  courseCtl courseCtl[] 
  reserveDetail reserveDetail[] // リレーションの逆参照用
}

model courseCtl {
  // 1. 外部キーは参照元の型（おそらくInt）に合わせ、@db.SmallIntは削除
  c_id     Int
  m_id     Int

  // 2. 外部キーリレーションの定義
  course   course @relation(fields: [c_id], references: [c_id])
  menu     menu   @relation(fields: [m_id], references: [m_id])

  // 3. ★修正: 複合主キーを定義
  // これにより、「どのコースにどのメニューが含まれるか」が一意に定まります。
  @@id([c_id, m_id])
}
